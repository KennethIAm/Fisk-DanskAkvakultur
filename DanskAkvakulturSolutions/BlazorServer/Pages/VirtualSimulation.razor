@page "/virtual-simulation"
@using DataClassLibrary.Simulation.Services.Interfaces
@layout GameLayout
@implements IAsyncDisposable

<head>
    <link rel="stylesheet" href="/assets/demo/TemplateData/style.css" />
</head>

<ShowAlertMessage Message="@(exceptionMessage)" Alert="@(MessageAlert.Error)" />

<ShowAlertMessage Message="@(result)" Alert="@(MessageAlert.Info)" />

<div id="unity-container" class="unity-desktop">
    <canvas id="unity-canvas" width=960 height=600></canvas>
    <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
            <div id="unity-progress-bar-full"></div>
        </div>
    </div>
    <div id="unity-mobile-warning">
        WebGL builds er ikke supporteret for mobile enheder.
        <div class="alert alert-warning" role="alert">
        </div>
    </div>
    <div id="unity-footer">
        <div id="unity-webgl-logo"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">FiskErFremtidenGameDemo</div>
    </div>
    <div class="footer-simulation">
        <div>
            <div class="shadow rounded">
                <button class="btn btn-primary btn-lg text-uppercase" style="width:250px;" disabled="@(!SimulationService.IsConnected)" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBackdrop" aria-controls="offcanvasWithBackdrop">
                    læs information
                </button>
            </div>
            <br />
            <div class="shadow rounded">

                <button class="btn btn-primary btn-lg text-uppercase" style="width:250px;" disabled="@(!SimulationService.IsConnected)" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasHighscore" aria-controls="offcanvasWithBackdrop">
                    vis rasultattavle
                </button>
            </div>
        </div>
    </div>
</div>

@*Offcanvas*@
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasWithBackdrop" aria-labelledby="offcanvasWithBackdropLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBackdropLabel">{{ AnimalName }}</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Cursus risus at ultrices mi tempus imperdiet nulla malesuada. Viverra nam libero justo laoreet sit amet cursus sit. Amet consectetur adipiscing elit ut aliquam purus sit amet luctus. Egestas integer eget aliquet nibh praesent tristique. Eu sem integer vitae justo eget. Integer quis auctor elit sed. Leo integer malesuada nunc vel risus commodo viverra maecenas. Egestas purus viverra accumsan in nisl. Interdum velit euismod in pellentesque massa. Convallis tellus id interdum velit laoreet id donec. Consequat ac felis donec et odio pellentesque. Et pharetra pharetra massa massa ultricies mi quis hendrerit dolor. Ac auctor augue mauris augue neque gravida in. Morbi leo urna molestie at elementum eu facilisis. Id nibh tortor id aliquet lectus proin nibh nisl condimentum. Habitasse platea dictumst quisque sagittis purus sit amet volutpat consequat. Ipsum suspendisse ultrices gravida dictum fusce ut.</p>
        <p>Faucibus nisl tincidunt eget nullam non nisi est. Sodales ut eu sem integer vitae justo. Etiam non quam lacus suspendisse faucibus interdum posuere lorem ipsum. Pulvinar sapien et ligula ullamcorper malesuada. Nisl condimentum id venenatis a condimentum vitae. Lacus sed viverra tellus in hac habitasse platea dictumst vestibulum. Habitasse platea dictumst vestibulum rhoncus est pellentesque. Lacus luctus accumsan tortor posuere ac ut consequat semper viverra. Amet volutpat consequat mauris nunc congue nisi vitae suscipit. Eu volutpat odio facilisis mauris sit amet massa vitae. Pulvinar proin gravida hendrerit lectus. Sapien et ligula ullamcorper malesuada proin. Vel eros donec ac odio tempor orci. Ligula ullamcorper malesuada proin libero nunc. Tempor nec feugiat nisl pretium fusce id. Vel pretium lectus quam id. Purus sit amet volutpat consequat mauris nunc. Bibendum est ultricies integer quis auctor elit sed. Amet mauris commodo quis imperdiet. Amet consectetur adipiscing elit ut aliquam.</p>
        <p>Id diam vel quam elementum pulvinar etiam. Mi quis hendrerit dolor magna eget est lorem ipsum. Vitae purus faucibus ornare suspendisse sed nisi lacus sed viverra. Dolor morbi non arcu risus quis varius. Id venenatis a condimentum vitae sapien pellentesque habitant. Id diam vel quam elementum. Senectus et netus et malesuada fames ac turpis egestas. Nisl condimentum id venenatis a condimentum vitae sapien pellentesque. Sodales ut etiam sit amet nisl purus in mollis. Suspendisse potenti nullam ac tortor. Lorem ipsum dolor sit amet consectetur adipiscing elit duis tristique. Lorem mollis aliquam ut porttitor leo a diam sollicitudin. Eu ultrices vitae auctor eu augue. Aliquam id diam maecenas ultricies. Viverra accumsan in nisl nisi scelerisque eu ultrices.</p>
    </div>
</div>

@*Offcanvas*@
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasHighscore" aria-labelledby="offcanvasWithBackdropLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBackdropLabel">Bedste Resultater</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <p>    1.                             1000000</p>
        <p>    2.                             9000000</p>
        <p>    3.                             8000000</p>
        <p>    4.                             7000000</p>
        <p>    5.                              600000</p>
        <p>    6.                              500000</p>
        <p>    7.                              400000</p>
        <p>    8.                              300000</p>
        <p>    9.                              200000</p>
        <p>    10.                              10000</p>
        <p>    MOCK SCORES</p>
    </div>
</div>

@code {
    [Inject] protected ILogger<VirtualSimulation> Logger { get; set; }
    [Inject] protected IJSRuntime JS { get; set; }
    [Inject] protected ISimulationService SimulationService { get; set; }

    private IJSObjectReference? module;
    private DotNetObjectReference<VirtualSimulation>? objRef;
    private string? result;
    private string exceptionMessage;

    protected override async Task OnInitializedAsync()
    {
        await SimulationService.ConnectAsync();

        base.ShouldRender();
        base.StateHasChanged();

        await StartEngine();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                objRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("setDotNetReference", objRef);

                module = await JS.InvokeAsync<IJSObjectReference>("import", "./assets/demo/game-engine.js");
            }
            catch (Exception)
            {
                exceptionMessage = "Fejlede indlæsning af Core Engine.";
            }
        }
    }

    [JSInvokable("LeaderboardData")]
    public async Task<bool> ReceiveLeaderboardAsync(float data)
    {
        if (data is 0) return false;

        Logger.LogInformation($"Received Leaderboad information : {data}");

        return await SimulationService.UpdateLeaderboardAsync((decimal)data);
    }

    private async Task StartEngine()
    {
        result = await LoadGameEngine();
    }

    public async ValueTask<string?> LoadGameEngine()
    {
        try
        {
            return await module.InvokeAsync<string>("loadUnityEngine");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, ex.Message);

            exceptionMessage = "Fejlede indlæsning af Virtuel Simulation.";

            return null;
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is not null)
        {
            try
            {
                await module.DisposeAsync();
                await SimulationService.DisposeAsync();

                Logger.LogInformation($"Diposed {nameof(module)} from {typeof(IJSObjectReference)}");
            }
            catch (Exception)
            {
                // Ignore, error during dispose of module.
            }
        }
    }
}
